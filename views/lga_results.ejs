<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LGA Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: linear-gradient(to right, #dc3545, #ce1126); min-height: 100vh; }
    .header { background: linear-gradient(135deg, #ffc107, #fd7e14); color: #003366; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); animation: slideInLeft 1s ease; }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    canvas { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); animation: fadeIn 1s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .total-votes { background: rgba(255,255,255,0.9); border-radius: 10px; padding: 1rem; text-align: center; margin: 1rem 0; }
  </style>
</head>
<body class="container-fluid p-4">
  <div class="header text-center">
    <h2><i class="fas fa-chart-bar me-2" style="color: #00b140;"></i>Question 2: LGA Aggregated Results</h2>
  </div>
  <div class="row justify-content-center mb-4">
    <div class="col-md-6">
      <form method="get">
        <div class="input-group">
          <select name="lga_id" class="form-select">
            <option value="">Select LGA</option>
            <% lgas.forEach(lga => { %>
              <option value="<%= lga.lga_id %>" <%= selectedLgaId == lga.lga_id ? 'selected' : '' %>><%= lga.lga_name %></option>
            <% }); %>
          </select>
          <button type="submit" class="btn btn-warning"><i class="fas fa-sync me-1"></i>Load</button>
        </div>
      </form>
    </div>
  </div>
  <% if (selectedLgaId) { %>
    <div class="row">
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-header bg-warning text-dark">
            <h4><i class="fas fa-balance-scale me-2"></i>Comparison for <%= selectedLgaId %></h4>
          </div>
          <div class="card-body">
            <div class="total-votes">
              <h5>Total Estimated Votes: <%= parties.reduce((sum, p) => sum + (estimated[p] || 0), 0) %> | Official: <%= parties.reduce((sum, p) => sum + (official[p] || 0), 0) %></h5>
            </div>
            <table class="table table-striped">
              <thead><tr><th>Party</th><th>Estimated (%)</th><th>Official (%)</th><th>Diff</th></tr></thead>
              <tbody>
                <% const estTotal = parties.reduce((sum, p) => sum + (estimated[p] || 0), 0); const offTotal = parties.reduce((sum, p) => sum + (official[p] || 0), 0); parties.forEach(party => { %>
                  <tr>
                    <td><%= party %></td>
                    <td><%= (estimated[party] || 0) %> (<%= Math.round(((estimated[party] || 0) / estTotal) * 100) %>%)</td>
                    <td><%= (official[party] || 0) %> (<%= Math.round(((official[party] || 0) / offTotal) * 100) %>%)</td>
                    <td class="<%- (comparison[party] > 0 ? 'text-success' : comparison[party] < 0 ? 'text-danger' : '') %>">
                      <%= comparison[party] || 0 %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-header bg-info text-white">
            <h4><i class="fas fa-bar-chart me-2"></i>Vote Comparison</h4>
          </div>
          <div class="card-body">
            <canvas id="lgaChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <script>
      const ctx = document.getElementById('lgaChart').getContext('2d');
      const partyLabels = <%- JSON.stringify(parties) %>;
      const estimatedData = <%- JSON.stringify(parties.map(p => estimated[p] || 0)) %>;
      const officialData = <%- JSON.stringify(parties.map(p => official[p] || 0)) %>;
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: partyLabels,
          datasets: [{
            label: 'Estimated (PU Sum)',
            data: estimatedData,
            backgroundColor: 'rgba(40, 167, 69, 0.6)',  // PDP Green
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 2
          }, {
            label: 'Official',
            data: officialData,
            backgroundColor: 'rgba(220, 53, 69, 0.6)',  // Red for official
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { position: 'top' } }
        }
      });
    </script>
  <% } else { %>
    <div class="alert alert-info text-center"><i class="fas fa-info-circle me-2"></i>Select an LGA to compare estimated totals from PUs vs. official announcements.</div>
  <% } %>
  <div class="text-center mt-4">
    <a href="/" class="btn btn-secondary btn-lg"><i class="fas fa-home me-1"></i>Home</a>
  </div>
</body>
</html>