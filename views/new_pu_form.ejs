<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New PU Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(to right, #ffc107, #fd7e14); min-height: 100vh; }
    .header { background: linear-gradient(135deg, #00b140, #ce1126); color: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); animation: bounceIn 1s ease; }
    @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
    .form-label { font-weight: bold; color: #003366; }
    .btn { border-radius: 25px; }
    .btn-success { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }
    .party-input { transition: all 0.3s; }
    .party-input:focus { transform: scale(1.02); box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
  </style>
</head>
<body class="container-fluid p-4">
  <div class="header text-center">
    <h2><i class="fas fa-plus-square me-2" style="color: #ffffff;"></i>Question 3: Add New Polling Unit</h2>
  </div>
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-body">
          <form id="puForm" class="needs-validation" novalidate>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label"><i class="fas fa-map me-2" style="color: #00b140;"></i>LGA (Delta State):</label>
                <select id="lgaSelect" class="form-select" required onchange="loadWards()">
                  <option value="">Select LGA</option>
                  <% lgas.forEach(lga => { %>
                    <option value="<%= lga.lga_id %>"><%= lga.lga_name %></option>
                  <% }); %>
                </select>
                <div class="invalid-feedback">Please select an LGA.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label"><i class="fas fa-building me-2" style="color: #007bff;"></i>Ward:</label>
                <select id="wardSelect" class="form-select" required disabled>
                  <option value="">Select Ward (after LGA)</option>
                </select>
                <div class="invalid-feedback">Please select a Ward.</div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label"><i class="fas fa-sign-in-alt me-2" style="color: #ffc107;"></i>Polling Unit Name:</label>
              <input type="text" id="puName" class="form-control party-input" required placeholder="e.g., New PU 11">
              <div class="invalid-feedback">PU name is required.</div>
            </div>
            <div class="row">
              <% parties.forEach(party => { %>
                <div class="col-md-4 mb-2">
                  <label class="form-label"><i class="fas fa-ticket-alt me-2" style="color: #dc3545;"></i><%= party %> Score:</label>
                  <input type="number" name="score_<%= party %>" min="0" class="form-control party-input" required placeholder="0">
                  <div class="invalid-feedback">Score must be >= 0.</div>
                </div>
              <% }); %>
            </div>
            <button type="submit" class="btn btn-success w-100 mt-3"><i class="fas fa-save me-1"></i>Save New PU</button>
          </form>
          <div id="message" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-4">
    <a href="/" class="btn btn-secondary btn-lg"><i class="fas fa-home me-1"></i>Home</a>
  </div>

  <script>
    const parties = <%- JSON.stringify(parties) %>;

    function loadWards() {
      const lgaId = document.getElementById('lgaSelect').value;
      const wardSelect = document.getElementById('wardSelect');
      if (!lgaId) {
        wardSelect.innerHTML = '<option value="">Select Ward</option>';
        wardSelect.disabled = true;
        return;
      }
      fetch(`/new-pu?lga_id=${lgaId}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) return alert(data.error);
          wardSelect.innerHTML = '<option value="">Select Ward</option>';
          data.wards.forEach(ward => {
            const opt = new Option(ward.ward_name, ward.ward_id);
            wardSelect.add(opt);
          });
          wardSelect.disabled = false;
        })
        .catch(err => alert('Error loading wards'));
    }

    document.getElementById('puForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!e.target.checkValidity()) {
        e.target.classList.add('was-validated');
        return;
      }
      const formData = new FormData();
      formData.append('lga_id', document.getElementById('lgaSelect').value);
      formData.append('ward_id', document.getElementById('wardSelect').value);
      formData.append('pu_name', document.getElementById('puName').value);
      parties.forEach(party => {  
        formData.append(`score_${party}`, document.querySelector(`input[name="score_${party}"]`).value);
      });
      const response = await fetch('/new-pu', { method: 'POST', body: formData });
      const result = await response.json();
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div class="alert alert-${result.success ? 'success' : 'danger'} animate__animated animate__bounceIn">${result.message}</div>`;
      if (result.success) {
        // Animation on success
        messageDiv.querySelector('.alert').style.animation = 'bounceIn 0.5s';
      }
    });
  </script>
</body>
</html>